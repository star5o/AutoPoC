 markdown 格式漏洞修复 diff：

---

### `src/backend/base/langflow/api/v1/validate.py`

```diff
@@ -1,6 +1,7 @@
 1  from fastapi import APIRouter, HTTPException
 2  from loguru import logger
 3  
 4+from langflow.api.utils import CurrentActiveUser
 5  from langflow.api.v1.base import Code, CodeValidationResponse, PromptValidationResponse, ValidatePromptRequest
 6  from langflow.base.prompts.api_utils import process_prompt_template
 7  from langflow.utils.validate import validate_code
@@ -10,7 +11,7 @@
11  
12  
13 @router.post("/code", status_code=200)
14-async def post_validate_code(code: Code) -> CodeValidationResponse:
14+async def post_validate_code(code: Code, _current_user: CurrentActiveUser) -> CodeValidationResponse:
15     try:
16         errors = validate_code(code.code)
17         return CodeValidationResponse(
```

---

### `src/backend/tests/unit/api/v1/test_validate.py`

```diff
@@ -1,14 +1,16 @@
 1+import pytest
 2 from fastapi import status
 3 from httpx import AsyncClient
 4 
 5-
 6-async def test_post_validate_code(client: AsyncClient):
 7+@pytest.mark.usefixtures("active_user")
 8+async def test_post_validate_code(client: AsyncClient, logged_in_headers):
 9     good_code = """
10 from pprint import pprint
11 var = {"a": 1, "b": 2}
12 pprint(var)
13     """
14-    response = await client.post("api/v1/validate/code", json={"code": good_code})
15+    response = await client.post("api/v1/validate/code", json={"code": good_code}, headers=logged_in_headers)
16     result = response.json()
17 
18     assert response.status_code == status.HTTP_200_OK
@@ -17,7 +19,8 @@
19     assert "function" in result, "The result must have a 'function' key"
20 
21-
22-async def test_post_validate_prompt(client: AsyncClient):
22+@pytest.mark.usefixtures("active_user")
23+async def test_post_validate_prompt(client: AsyncClient, logged_in_headers):
24     basic_case = {
25         "name": "string",
26         "template": "string",
@@ -48,10 +51,29 @@
51             "metadata": {},
52         },
53     }
54-    response = await client.post("api/v1/validate/prompt", json=basic_case)
55+    response = await client.post("api/v1/validate/prompt", json=basic_case, headers=logged_in_headers)
56     result = response.json()
57 
58     assert response.status_code == status.HTTP_200_OK
59     assert isinstance(result, dict), "The result must be a dictionary"
60     assert "frontend_node" in result, "The result must have a 'frontend_node' key"
61     assert "input_variables" in result, "The result must have an 'input_variables' key"
62+
63+
64+@pytest.mark.usefixtures("active_user")
65+async def test_post_validate_prompt_with_invalid_data(client: AsyncClient, logged_in_headers):
66+    invalid_case = {
67+        "name": "string",
68+        # Missing required fields
69+        "frontend_node": {"template": {}, "is_input": True},
70+    }
71+    response = await client.post("api/v1/validate/prompt", json=invalid_case, headers=logged_in_headers)
72+    assert response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY
73+
74+
75+async def test_post_validate_code_with_unauthenticated_user(client: AsyncClient):
76+    code = """
77+    print("Hello World")
78+    """
79+    response = await client.post("api/v1/validate/code", json={"code": code}, headers={"Authorization": "Bearer fake"})
80+    assert response.status_code == status.HTTP_401_UNAUTHORIZED
```

---

### `src/backend/tests/unit/test_endpoints.py`

```diff
@@ -127,15 +127,16 @@
127     assert "ChatOutput" in json_response["outputs"]
128 
129 
130-async def test_post_validate_code(client: AsyncClient):
130+@pytest.mark.usefixtures("active_user")
131+async def test_post_validate_code(client: AsyncClient, logged_in_headers):
132     # Test case with a valid import and function
133     code1 = """
134 import math
135 
136 def square(x):
137     return x ** 2
138 """
139-    response1 = await client.post("api/v1/validate/code", json={"code": code1})
139+    response1 = await client.post("api/v1/validate/code", json={"code": code1}, headers=logged_in_headers)
140     assert response1.status_code == 200
141     assert response1.json() == {"imports": {"errors": []}, "function": {"errors": []}}
142 
@@ -146,7 +147,7 @@
147 def square(x):
148     return x ** 2
149 """
150-    response2 = await client.post("api/v1/validate/code", json={"code": code2})
150+    response2 = await client.post("api/v1/validate/code", json={"code": code2}, headers=logged_in_headers)
151     assert response2.status_code == 200
152     assert response2.json() == {
153         "imports": {"errors": ["No module named 'non_existent_module'"]},
@@ -160,19 +161,19 @@
161 def square(x)
162     return x ** 2
163 """
164-    response3 = await client.post("api/v1/validate/code", json={"code": code3})
164+    response3 = await client.post("api/v1/validate/code", json={"code": code3}, headers=logged_in_headers)
165     assert response3.status_code == 200
166     assert response3.json() == {
167         "imports": {"errors": []},
168         "function": {"errors": ["expected ':' (<unknown>, line 4)"]},
169     }
170 
171     # Test case with invalid JSON payload
172-    response4 = await client.post("api/v1/validate/code", json={"invalid_key": code1})
172+    response4 = await client.post("api/v1/validate/code", json={"invalid_key": code1}, headers=logged_in_headers)
173     assert response4.status_code == 422
174 
175     # Test case with an empty code string
176-    response5 = await client.post("api/v1/validate/code", json={"code": ""})
176+    response5 = await client.post("api/v1/validate/code", json={"code": ""}, headers=logged_in_headers)
177     assert response5.status_code == 200
178     assert response5.json() == {"imports": {"errors": []}, "function": {"errors": []}}
179 
@@ -183,7 +184,7 @@
184 def square(x)
185     return x ** 2
186 """
187-    response6 = await client.post("api/v1/validate/code", json={"code": code6})
187+    response6 = await client.post("api/v1/validate/code", json={"code": code6}, headers=logged_in_headers)
188     assert response6.status_code == 200
189     assert response6.json() == {
190         "imports": {"errors": []},
```

---

如需进一步格式化或拆分，请告知~